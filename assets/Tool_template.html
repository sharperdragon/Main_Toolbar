<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Toolbar Editor</title>
<style>

</style>
<script>
let model = []; // hydrated from Python
let dragIndex = null;

function rowHtml(r, i) {
  const esc = s => (s ?? "").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;");
  return `
    <tr draggable="true" data-index="${i}">
      <td><input value="${esc(r.name)}" onchange="onEdit(${i}, 'name', this.value)"></td>
      <td><input value="${esc(r.module)}" onchange="onEdit(${i}, 'module', this.value)"></td>
      <td><input value="${esc(r.function)}" onchange="onEdit(${i}, 'function', this.value)"></td>
      <td><input value="${esc(r.submenu)}" onchange="onEdit(${i}, 'submenu', this.value)"></td>
      <td><input value="${esc(r.icon)}" onchange="onEdit(${i}, 'icon', this.value)"></td>
      <td><input type="checkbox" ${r.enabled ? "checked": ""} onchange="onEdit(${i}, 'enabled', this.checked)"></td>
      <td class="row-actions">
        <button onclick="onAddAfter(${i})">+</button>
        <button onclick="onDelete(${i})">–</button>
        <button onclick="onDivider(${i})">Divider</button>
      </td>
    </tr>
  `;
}

function render() {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = model.map(rowHtml).join("");
  // wire dnd
  tbody.querySelectorAll("tr").forEach(tr => {
    tr.addEventListener("dragstart", (e) => { dragIndex = +tr.dataset.index; });
    tr.addEventListener("dragover", (e) => e.preventDefault());
    tr.addEventListener("drop", (e) => {
      e.preventDefault();
      const to = +tr.dataset.index;
      if (dragIndex === null || to === dragIndex) return;
      const [moved] = model.splice(dragIndex, 1);
      model.splice(to, 0, moved);
      dragIndex = null;
      render();
    });
  });
}

function onEdit(i, key, val) { model[i][key] = val; }
function onAdd() { model.push({name:"", module:"", function:"", submenu:"", icon:"", enabled:true}); render(); }
function onAddAfter(i) { model.splice(i+1, 0, {name:"", module:"", function:"", submenu:"", icon:"", enabled:true}); render(); }
function onDelete(i) { model.splice(i,1); render(); }
function onDivider(i) { model.splice(i+1, 0, {name:"———", module:"", function:"", submenu:"", icon:"", enabled:false, type:"separator"}); render(); }

function onSave() {
  // ensure Toolbar Settings row exists
  if (!model.some(x => (x.name || "").toLowerCase() === "toolbar settings")) {
    model.push({name:"Toolbar Settings", module:"Main_Toolbar.toolbar_editor", function:"edit_toolbar_json", submenu:"", icon:"icons/bent_menu-burger.svg", enabled:true});
  }
  const payload = JSON.stringify(model);
  pycmd("toolbar_editor:save:" + payload);
}

function hydrate(jsonStr) {
  try {
    model = JSON.parse(jsonStr);
  } catch(e) { model = []; }
  render();
}

function askRefresh() { pycmd("toolbar_editor:refresh"); }

</script>
</head>
<body>
  <div class="controls">
    <button onclick="onAdd()">Add</button>
    <button onclick="onSave()">Save</button>
    <span class="small">Right-click → Inspect (DevTools)</span>
  </div>
  <table>
    <thead>
      <tr>
        <th>Name</th><th>Module</th><th>Function</th><th>Submenu</th><th>Icon</th><th>Enabled</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <script>/* model is injected below by Python via view.eval(...) */</script>
</body>
</html>
"""